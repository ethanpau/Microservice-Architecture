## 注册中心设计与实践 ##

#### 服务注册与发现 ####

> __ZooKeeper定义__  
> 
> - 分布式应用程序协调服务
>   - 节点选主  
>   - 配置管理  
>   - 粗粒度分布式锁
>   - _服务注册_  
>   - _服务发现_
> 
> _ZooKeeper功能_  
>   
> - 文件系统  
> - 通知机制  

|对比维度|Zookeeper|etcd|Consul|Eureka|Nacos|  
|:---|:---|:---|:---|:---|:---|
|CAP模型|CP|CP|CP|AP|AP/CP|
|数据一致性|ZAP(Paxos)|Raft|Raft|不支持|Raft/Gossip|
|多数据中心|不支持|不支持|支持(Gossip)|支持|支持|
|多语言支持|SDK客户端|HTTP/gRPC|HTTP/DNS|HTTP|gRPC/Dubbo/Spring Cloud RESTful|
|Watch支持|支持|Long Polling|Long Polling|Long polling|支持|
|KV存储|支持|支持|支持|不支持|MYSQL|
|服务健康检查|心跳|心跳|服务状态、内存、磁盘等|需显示配置|Ping/TCP/HTTP/MySQL/agent/用户自定义|
|自身监控|不支持|metrics|metrics|metrics|metrics|
|Spring Cloud 集成|支持|支持|支持|支持|支持（Dubbo/K8S）|
|自身语言|Java|Go|Go|Java|Java|
|社区支持|积极|积极|积极|新版本已暂停|积极|

#### 注册中心是CP还是AP ####
- 数据一致性需求分析
	- 注册中心本质（Query函数）
	
	> - Si=F(ServiceName)
	> - ServiceName查询服务参数
	> - Si为对应服务可用的(IP:PORT)列表
	
	- 不一致影响
		- 节点流量不均衡

___对数据一致性要求不高，数据最终一致即可___

#### 服务规模容量连通性 ####
- 互联网微服务规模剧增
- 服务规模 = F(服务注册数，服务订阅数)超过一定数量(1000)，zookeeper将会不堪重负
- 服务发布大量注册写请求
- 毫秒级服务健康状态的写请求
- 服务与注册中心海量长连接
- zookeeper写单点，不能水平扩展问题 
	- 按照业务功能垂直拆分zookeeper集群
	- 破坏了服务连通性
	- 业务整合联通不可预知
	  - 商品一个注册中心
	  - 交易一个注册中心
	  - 搜索一个注册中心
	  - 推荐一个注册中心

#### 持久化存储和事务日志 ####
- 不需存储
  - 最核心的数据 - 实时的健康的服务列表
  - ZAP协议对每个写请求在节点上保持写一个事务日志
  - 定期将内存数据镜像dump到磁盘，保持数据一致性和持久性，保证宕机数据可恢复
  - 调用方关注要调用服务的实时地址列表和实时健康状态
  - 调用方并不关心服务的历史地址列表、过去的健康状态

- 需要存储
  - 服务的元数据信息（服务的版本、分组、所在的机房、权重、鉴权策略信息、服务标签等元信息）

#### 服务健康检查 #### 
- 探活机制 
  - 服务的健康检查常利用ZooKeeper的Session活性心跳机制（ping）以及结合Ephemeral ZNode的机制
  - 绑定在TCP长连接活性探测
  - 存在问题
    - 服务健康情况无法真正探测
    - 服务假死问题

#### 注册中心容灾考虑 ####
- 注册中心不能因为自身的任何原因破坏服务之间本身的可连通性
  - 服务调用链路需要弱依赖注册中心，必须仅在服务发布、机器上下线，服务扩缩容等必要时才依赖
  - 客户端设计考虑容灾
    - 缓存数据机制
    - ZooKeeper节点全干掉，应用服务是否正常Work
    - 原生ZooKeeper客户端并不具备(Netflix Curator比原生好些)

#### ZooKeeper使用场合 ####
- The King Of Coordination for Big Data   
  - 在粗粒度分布式锁，分布式选主，主备高可用切换等不需要高TPS支持的场景下有可替代的作用
  - 这些需求往往多集中在大数据、离线任务等相关的业务领域，因为大数据领域，讲究分割数据集，并且大部分时间分任务多进程/线程并行处理这些数据集，但是总是有一些点上需要将这些任务和进程统一协调，这时候就是ZooKeeper发挥巨大作用之时
  - 适用场景（大数据、分布式协调）
  - 不适用场景（大规模交易、大规模服务发现与注册）

#### 自研注册中心目标 ####
- 提供可跨语言使用服务注册与发现平台
- 提供指令下发功能对集群服务进行管理
  - 管控指令存在时效性，指令是可损的
- 提供节点信息存储与拓展
  - 服务器类型（物理机、虚拟机、Docker容器等）、节点权重、服务分组等

## 配置中心设计与实践 ##
#### 配置中心定义 ####
- 应用服务配置统一存储和管理的可视化系统
	- 配置是独立于程序的只读变量
	- 配置伴随应用的整个生命周期
	- 配置可以有多种加载方式
	- 配置需要治理（权限控制\|不同环境、集群配置管理）

#### 配置中心的目的 ####
- 服务重启的成本  
- 随着程序功能的日益复杂，程序的配置日益增多：各种功能开关、参数的配置、服务器的地址等  
- 对配置的期望也越来越高，配置修改后实时生效，灰度发布，分环境、分集群管理配置，完善的权限、审核机制等  
- 随着采用分布式的开发模式，项目之间的相互引用随着服务的不断增多，相互之间的调用复杂度成指数升高，每次上线新项目时苦不堪言

#### 开源配置中心 ####
||Spring Cloud Config|Ctrip Apollo|百度disconf|
|---|---|---|---|
|本地缓存|不支持|支持|支持|
|配置生效时间|重启生效|实时|实时|
|配置版本管理|不支持|界面直接支持|不支持|
|灰度发布|不支持|支持|支持不完善|
|多环境|不支持|支持|支持|
|报警通知|不支持|支持邮件|支持邮件|
|配置界面|不支持|支持|支持|
|客户端支持|Java|Java、.net、HTTP|Java|
|业务系统侵入性|低|低|低|
|单点故障|支持HA|支持HA|支持Ha|
|多数据中心支持|支持|支持|支持|
|依赖组件|Eurake|Eurake|ZooKeeper|
|自身语言|Java|Java|Java|

