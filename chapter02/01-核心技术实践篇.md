## 高可用设计手段 ##
定义  
> 7\*24（服务）小时，任何人（用户）在任何时间、地点访问任何服务都能够得到想要的结果

评估方式

> 一段时间(比如一年)的停机影响请求量(TPS|QPS|订单等可量化指标)占比***停机时间影响请求量/总请求量***  
_停机时间不建议作为评估高可用变量，主要考虑到请求高峰与低峰时间段内，影响范围不同_  

微服务高可用设计手段  

- 服务冗余：保证服务的无状态，服务弹性扩缩容
- 负载均衡：
- 幂等设计：请求幂等、业务幂等
- 超时机制：时长设置、重试机制（一般3次，具体视业务而定）
- 异步化设计：提高吞吐量（高并发），且请求响应不依赖业务逻辑处理结果
- 服务限流降级熔断：
- 数据复制/缓存/Sharding：
- 架构拆分、服务治理：

- 网关层已具备热切换能力
	- 热开关切换
	- 业务日志\|利用前后端超时时间
- 网关层不具备热切换能力
	- 防火墙（IPTABLES）设置请求只进不出

## 服务无状态化设计与实践 ##
#### 服务无状态化定义 ####

- 同一服务（进程）冗余部署N份，N份完全对等
- 请求提交到任何一份冗余服务上，处理结果完全一致

#### 服务无状态化目的 ####

- 弹性扩缩容

案例  
> 用户登录认证成功，Session数据存储  
> 
> - 存放到外部存储系统(Redis)——存储系统扩容，涉及数据迁移或者静默登录  
> - JWT（JSON Web Token）, 本质是将数据存储到了客户端（APP）——session有丢失的风险、网络传输数据量增大  

## 服务负载均衡设计和实践 ##
#### 狭义负载均衡 ####
常见负载均衡系统  

- 硬件：F5、A10、Radware  
- 软件：LVS（4层）、Nginx（7层）、HAProxy（4层\|7层）

#####  负载均衡算法 #####
- **Random**：随机，按权重设置随机概率  
- **RoundRobin**：轮循，按约定后端权重设置轮循比率  
- **ConsistentHash**：一致性Hash，相同参数的请求总是发到同一提供者   

#### 广义负载均衡

- 完整的故障处理回复机制  
  - 故障自动发现(服务注册与发现，上报心跳)  
  - 故障服务自动摘除     
      - 服务熔断机制(心跳并不能发现服务的假死，服务调用方维护服务提供方的请求成功失败比率)    
  - 请求自动重试  
  - 服务回复自动发现  

## 服务幂等设计与实践 ##

#### 业务场景驱动  
- 用户转账(请求幂等) —— 首次转账（失败），重试（一个请求重复执行，保证结果正确性）  
- 用户下单(业务幂等) —— 同一时间段内只允许下单一次（多次请求）  

#### 请求幂等
- 保证请求重复执行和执行一次结果相同  
- 请求分类：读请求(不改变数据本身，无需幂等处理)、写请求(insert、update、delete，需要做幂等处理)    
- 架构层面：反向代理层、网关层、业务逻辑层、数据访问层（幂等处理 *CRUD*）、DB层  
    - C(Creator/Insert): 采用业务主键（唯一约束）
    - R(Read/Select): 天然幂等
    - U(Update): 绝对值修改，本身幂等；相对值的修改——乐观锁（本质就是个版本号）保证幂等
    - D(Delete): 天然幂等  
	***跨服务（数据库）数据编辑，分布式事物***





















